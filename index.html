<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Clínica Odontológica</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-custom {
            background: #667eea;
        }
        .card-header-custom {
            background: #667eea;
            color: white;
        }
        .btn-custom {
            background: #667eea;
            border: none;
            color: white;
        }
        .btn-custom:hover {
            background: #5a6fd8;
            color: white;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tooth me-2"></i>Clínica Odontológica
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light me-2" onclick="showSection('pacientes')">
                    <i class="fas fa-users me-1"></i>Pacientes
                </button>
                <button class="btn btn-outline-light" onclick="showSection('citas')">
                    <i class="fas fa-calendar-alt me-1"></i>Citas
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Sección Pacientes -->
        <div id="pacientes-section" class="section">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header card-header-custom">
                            <h5><i class="fas fa-user-plus me-2"></i>Gestión de Pacientes</h5>
                        </div>
                        <div class="card-body">
                            <form id="formPaciente">
                                <input type="hidden" id="pacienteId" name="id">
                                <div class="mb-3">
                                    <label for="nombrePaciente" class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="nombrePaciente" name="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label for="documentoPaciente" class="form-label">Documento</label>
                                    <input type="text" class="form-control" id="documentoPaciente" name="documento" required>
                                </div>
                                <div class="mb-3">
                                    <label for="telefonoPaciente" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="telefonoPaciente" name="telefono" required>
                                </div>
                                <div class="mb-3">
                                    <label for="correoPaciente" class="form-label">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="correoPaciente" name="correo" required>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-custom" id="btnPaciente">
                                        <i class="fas fa-save me-1"></i>Guardar Paciente
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormularioPaciente()">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-users me-2"></i>Lista de Pacientes</h5>
                            <button class="btn btn-outline-light btn-sm" onclick="cargarPacientes()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="loading text-center p-3" id="loadingPacientes">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                            </div>
                            <div class="table-container">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Documento</th>
                                            <th>Teléfono</th>
                                            <th>Correo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaPacientes">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Citas -->
        <div id="citas-section" class="section" style="display: none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header card-header-custom">
                            <h5><i class="fas fa-calendar-plus me-2"></i>Gestión de Citas</h5>
                        </div>
                        <div class="card-body">
                            <form id="formCita">
                                <input type="hidden" id="citaId" name="id">
                                <div class="mb-3">
                                    <label for="pacienteIdCita" class="form-label">Paciente</label>
                                    <select class="form-select" id="pacienteIdCita" name="paciente_id" required>
                                        <option value="">Seleccionar paciente...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fechaCita" class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="fechaCita" name="fecha" required>
                                </div>
                                <div class="mb-3">
                                    <label for="horaCita" class="form-label">Hora</label>
                                    <input type="time" class="form-control" id="horaCita" name="hora" required>
                                </div>
                                <div class="mb-3">
                                    <label for="odontologoCita" class="form-label">Odontólogo</label>
                                    <input type="text" class="form-control" id="odontologoCita" name="odontologo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="estadoCita" class="form-label">Estado</label>
                                    <select class="form-select" id="estadoCita" name="estado" required>
                                        <option value="">Seleccionar estado...</option>
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="Confirmada">Confirmada</option>
                                        <option value="Cancelada">Cancelada</option>
                                    </select>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-custom" id="btnCita">
                                        <i class="fas fa-save me-1"></i>Guardar Cita
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="limpiarFormularioCita()">
                                        <i class="fas fa-times me-1"></i>Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-calendar-alt me-2"></i>Lista de Citas</h5>
                            <button class="btn btn-outline-light btn-sm" onclick="cargarCitas()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="loading text-center p-3" id="loadingCitas">
                                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
                            </div>
                            <div class="table-container">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Paciente</th>
                                            <th>Fecha</th>
                                            <th>Hora</th>
                                            <th>Odontólogo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaCitas">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let pacientes = [];
        let citas = [];
        let editandoPaciente = false;
        let editandoCita = false;

        // Función para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            alert.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Función para mostrar secciones
        function showSection(section) {
            document.getElementById('pacientes-section').style.display = 'none';
            document.getElementById('citas-section').style.display = 'none';
            
            document.getElementById(section + '-section').style.display = 'block';
            
            if (section === 'pacientes') {
                cargarPacientes();
            } else if (section === 'citas') {
                cargarCitas();
                cargarPacientesParaSelect();
            }
        }

        // FUNCIONES PARA PACIENTES
        async function cargarPacientes() {
            const loading = document.getElementById('loadingPacientes');
            const tabla = document.getElementById('tablaPacientes');
            
            loading.classList.add('show');
            
            try {
                const response = await fetch('Pacientes/leer_paciente.php');
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    pacientes = data;
                    tabla.innerHTML = '';
                    
                    data.forEach(paciente => {
                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                            <td>${paciente.id}</td>
                            <td>${paciente.nombre}</td>
                            <td>${paciente.documento}</td>
                            <td>${paciente.telefono}</td>
                            <td>${paciente.correo}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editarPaciente(${paciente.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarPaciente(${paciente.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tabla.appendChild(fila);
                    });
                } else {
                    mostrarAlerta('Error al cargar pacientes: ' + (data.message || 'Error desconocido'), 'danger');
                }
            } catch (error) {
                mostrarAlerta('Error de conexión al cargar pacientes', 'danger');
                console.error('Error:', error);
            }
            
            loading.classList.remove('show');
        }

        async function cargarPacientesParaSelect() {
            const select = document.getElementById('pacienteIdCita');
            
            try {
                const response = await fetch('Pacientes/leer_paciente.php');
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    select.innerHTML = '<option value="">Seleccionar paciente...</option>';
                    data.forEach(paciente => {
                        select.innerHTML += `<option value="${paciente.id}">${paciente.nombre} (${paciente.documento})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error al cargar pacientes para select:', error);
            }
        }

        document.getElementById('formPaciente').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const pacienteData = {
                nombre: formData.get('nombre'),
                documento: formData.get('documento'),
                telefono: formData.get('telefono'),
                correo: formData.get('correo')
            };
            
            try {
                let url, method, bodyData;
                
                if (editandoPaciente) {
                    url = 'Pacientes/editar_paciente.php';
                    bodyData = {
                        id: parseInt(formData.get('id')),
                        ...pacienteData
                    };
                } else {
                    url = 'Pacientes/crear_paciente.php';
                    bodyData = {
                        paciente: pacienteData
                    };
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bodyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarAlerta(result.message, 'success');
                    limpiarFormularioPaciente();
                    cargarPacientes();
                    if (document.getElementById('citas-section').style.display !== 'none') {
                        cargarPacientesParaSelect();
                    }
                } else {
                    mostrarAlerta(result.message, 'danger');
                }
            } catch (error) {
                mostrarAlerta('Error de conexión', 'danger');
                console.error('Error:', error);
            }
        });

        function editarPaciente(id) {
            const paciente = pacientes.find(p => p.id == id);
            if (paciente) {
                document.getElementById('pacienteId').value = paciente.id;
                document.getElementById('nombrePaciente').value = paciente.nombre;
                document.getElementById('documentoPaciente').value = paciente.documento;
                document.getElementById('telefonoPaciente').value = paciente.telefono;
                document.getElementById('correoPaciente').value = paciente.correo;
                document.getElementById('btnPaciente').innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Paciente';
                editandoPaciente = true;
            }
        }

        async function eliminarPaciente(id) {
            if (confirm('¿Está seguro de que desea eliminar este paciente?')) {
                try {
                    const response = await fetch('Pacientes/eliminar_paciente.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: id })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        cargarPacientes();
                    } else {
                        mostrarAlerta(result.message, 'danger');
                    }
                } catch (error) {
                    mostrarAlerta('Error de conexión', 'danger');
                    console.error('Error:', error);
                }
            }
        }

        function limpiarFormularioPaciente() {
            document.getElementById('formPaciente').reset();
            document.getElementById('pacienteId').value = '';
            document.getElementById('btnPaciente').innerHTML = '<i class="fas fa-save me-1"></i>Guardar Paciente';
            editandoPaciente = false;
        }

        // FUNCIONES PARA CITAS
        async function cargarCitas() {
            const loading = document.getElementById('loadingCitas');
            const tabla = document.getElementById('tablaCitas');
            
            loading.classList.add('show');
            
            try {
                const response = await fetch('Citas/leer_cita.php');
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    citas = data;
                    tabla.innerHTML = '';
                    
                    data.forEach(cita => {
                        const paciente = pacientes.find(p => p.id == cita.paciente_id);
                        const nombrePaciente = paciente ? paciente.nombre : `ID: ${cita.paciente_id}`;
                        
                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                            <td>${cita.id}</td>
                            <td>${nombrePaciente}</td>
                            <td>${cita.fecha}</td>
                            <td>${cita.hora}</td>
                            <td>${cita.odontologo}</td>
                            <td><span class="badge bg-${getEstadoColor(cita.estado)}">${cita.estado}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editarCita(${cita.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarCita(${cita.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tabla.appendChild(fila);
                    });
                } else {
                    mostrarAlerta('Error al cargar citas: ' + (data.message || 'Error desconocido'), 'danger');
                }
            } catch (error) {
                mostrarAlerta('Error de conexión al cargar citas', 'danger');
                console.error('Error:', error);
            }
            
            loading.classList.remove('show');
        }

        function getEstadoColor(estado) {
            switch(estado) {
                case 'Pendiente': return 'warning';
                case 'Confirmada': return 'success';
                case 'Cancelada': return 'danger';
                default: return 'secondary';
            }
        }

        document.getElementById('formCita').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const citaData = {
                paciente_id: formData.get('paciente_id'),
                fecha: formData.get('fecha'),
                hora: formData.get('hora'),
                odontologo: formData.get('odontologo'),
                estado: formData.get('estado')
            };
            
            try {
                let url, bodyData;
                
                if (editandoCita) {
                    url = 'Citas/editar_cita.php';
                    bodyData = {
                        id: parseInt(formData.get('id')),
                        ...citaData
                    };
                } else {
                    url = 'Citas/crear_cita.php';
                    bodyData = {
                        cita: citaData
                    };
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bodyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarAlerta(result.message, 'success');
                    limpiarFormularioCita();
                    cargarCitas();
                } else {
                    mostrarAlerta(result.message, 'danger');
                }
            } catch (error) {
                mostrarAlerta('Error de conexión', 'danger');
                console.error('Error:', error);
            }
        });

        function editarCita(id) {
            const cita = citas.find(c => c.id == id);
            if (cita) {
                document.getElementById('citaId').value = cita.id;
                document.getElementById('pacienteIdCita').value = cita.paciente_id;
                document.getElementById('fechaCita').value = cita.fecha;
                document.getElementById('horaCita').value = cita.hora;
                document.getElementById('odontologoCita').value = cita.odontologo;
                document.getElementById('estadoCita').value = cita.estado;
                document.getElementById('btnCita').innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Cita';
                editandoCita = true;
            }
        }

        async function eliminarCita(id) {
            if (confirm('¿Está seguro de que desea eliminar esta cita?')) {
                try {
                    const response = await fetch('Citas/eliminar_cita.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: id })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        mostrarAlerta(result.message, 'success');
                        cargarCitas();
                    } else {
                        mostrarAlerta(result.message, 'danger');
                    }
                } catch (error) {
                    mostrarAlerta('Error de conexión', 'danger');
                    console.error('Error:', error);
                }
            }
        }

        function limpiarFormularioCita() {
            document.getElementById('formCita').reset();
            document.getElementById('citaId').value = '';
            document.getElementById('btnCita').innerHTML = '<i class="fas fa-save me-1"></i>Guardar Cita';
            editandoCita = false;
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            cargarPacientes();
            
            // Establecer fecha mínima para citas (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaCita').setAttribute('min', today);
        });
    </script>
</body>
</html>